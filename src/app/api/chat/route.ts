import { NextRequest, NextResponse } from 'next/server'
import OpenAI from 'openai'

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY
})

interface ChatRequest {
  userMessage: string
  conversationHistory: Array<{
    role: 'user' | 'assistant'
    content: string
  }>
  mode: 'conversation' | 'extract_keywords'
}

interface KeywordExtractionResult {
  keywords: string[]
  confidence: number
  reasoning: string
}

// è³ªå•ã‚»ãƒƒãƒˆï¼ˆã‚¬ã‚¤ãƒ€ãƒ³ã‚¹ç”¨ï¼‰ - å°å­¦ç”Ÿå‘ã‘ã«ç°¡æ½”ã§ç†è§£ã—ã‚„ã™ã„è³ªå•
const INTEREST_QUESTIONS = [
  "å¥½ããªæœ¬ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã­ï¼ã©ã‚“ãªè©±ãŒå¥½ãï¼Ÿ",
  "æ™®æ®µã©ã‚“ãªã“ã¨ã‚’ã—ã¦éŠã¶ã®ãŒå¥½ãï¼Ÿã‚¹ãƒãƒ¼ãƒ„ã¨ã‹ã€ã‚²ãƒ¼ãƒ ã¨ã‹ã€ãªã‚“ã§ã‚‚ã„ã„ã‚ˆï¼",
  "å‹•ç‰©ã€å®‡å®™ã€æç«œã€ãŠæ–™ç†ãªã©ã€ã©ã‚“ãªã“ã¨ã«èˆˆå‘³ãŒã‚ã‚‹ï¼Ÿ", 
  "æœ€è¿‘æ¥½ã—ã‹ã£ãŸã“ã¨ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ï¼",
  "å¤§ãããªã£ãŸã‚‰ä½•ã«ãªã‚ŠãŸã„ï¼Ÿã‚„ã£ã¦ã¿ãŸã„ã“ã¨ã¯ã‚ã‚‹ï¼Ÿ"
]

// OpenAI APIã‚’ä½¿ã£ãŸä¼šè©±ç”Ÿæˆ
async function generateResponseWithOpenAI(userMessage: string, conversationHistory: Array<{role: string, content: string}>): Promise<string> {
  try {
    const questionCount = conversationHistory.filter(msg => msg.role === 'assistant').length
    
    const systemPrompt = `ã‚ãªãŸã¯å°å­¦ç”Ÿã¨ä»²è‰¯ã—ã®AIå…ˆç”Ÿã§ã™ã€‚å­ã©ã‚‚ã¨æ¥½ã—ããŠè©±ã—ã¦ã€ãã®å­ã«ã´ã£ãŸã‚Šã®æœ¬ã‚’è¦‹ã¤ã‘ã‚‹ãŠæ‰‹ä¼ã„ã‚’ã—ã¾ã™ã€‚

å­ã©ã‚‚ã®èˆˆå‘³ã‚„å¥½ããªã“ã¨ã‚’èã„ã¦ãã ã•ã„ï¼š
1. å¥½ããªæœ¬ã‚„ç‰©èª
2. éŠã³ã‚„è¶£å‘³ï¼ˆã‚¹ãƒãƒ¼ãƒ„ã€ã‚²ãƒ¼ãƒ ã€ãŠçµµã‹ããªã©ï¼‰
3. èˆˆå‘³ãŒã‚ã‚‹ã“ã¨ï¼ˆå‹•ç‰©ã€å®‡å®™ã€æç«œã€æ–™ç†ãªã©ï¼‰
4. æ¥½ã—ã‹ã£ãŸå‡ºæ¥äº‹ã‚„å°†æ¥ã®å¤¢

ä»Šã¯${questionCount + 1}å›ç›®ã®è³ªå•ã§ã™ã€‚

é‡è¦ãªãƒ«ãƒ¼ãƒ«ï¼š
- 1ã€œ4å›ç›®ï¼šå­ã©ã‚‚ã®ç­”ãˆã‚’è¤’ã‚ã¦ã‹ã‚‰æ¬¡ã®è³ªå•ã‚’ã™ã‚‹
- 5å›ç›®ï¼šå­ã©ã‚‚ã®ç­”ãˆã‚’è¤’ã‚ã¦ã‹ã‚‰ã€ŒãŸãã•ã‚“æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ãã¿ã«ã´ã£ãŸã‚Šã®æœ¬ã‚’æ¢ã—ã¦ãã‚‹ã­ã€œï¼âœ¨ã€ã§çµ‚äº†ã™ã‚‹
- çµ¶å¯¾ã«5å›ã‚’è¶…ãˆã¦è³ªå•ã—ãªã„

è©±ã—æ–¹ã®ãƒ«ãƒ¼ãƒ«ï¼š
- ã²ã‚‰ãŒãªã‚’å¤šãä½¿ã„ã€æ¼¢å­—ã¯å°å­¦ç”Ÿãƒ¬ãƒ™ãƒ«ã«
- ã€Œã€œã ã‚ˆã€ã€Œã€œã ã­ã€ãªã©è¦ªã—ã¿ã‚„ã™ã
- çŸ­ã‚ã®æ–‡ã§è©±ã™
- å­ã©ã‚‚ã®ç­”ãˆã‚’è¤’ã‚ã¦ã€èˆˆå‘³ã‚’ç¤ºã™
- è³ªå•ã¯1ã¤ãšã¤ã€ã‚ã‹ã‚Šã‚„ã™ã`

    const systemMessage = { role: 'system' as const, content: systemPrompt }
    const historyMessages = conversationHistory.map(msg => ({
      role: msg.role as 'user' | 'assistant',
      content: msg.content
    }))
    const currentUserMessage = { role: 'user' as const, content: userMessage }

    const completion = await openai.chat.completions.create({
      model: 'gpt-4.1-2025-04-14',
      messages: [systemMessage, ...historyMessages, currentUserMessage],
      max_tokens: 150,
      temperature: 0.7
    })

    return completion.choices[0].message?.content || "ã™ã¿ã¾ã›ã‚“ã€ã‚‚ã†ä¸€åº¦ãŠèã‹ã›ãã ã•ã„ã€‚"
    
  } catch (error) {
    console.error('OpenAI API error:', error)
    // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚·ãƒ³ãƒ—ãƒ«ãªå¿œç­”
    const questionCount = conversationHistory.filter(msg => msg.role === 'assistant').length
    
    // è³ªå•å›æ•°ã«å¿œã˜ã¦å¿œç­”ã‚’æ±ºå®š
    if (questionCount === 5) {
      // 5å›ç›®ï¼ˆæœ€çµ‚å›ï¼‰ã¯çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸
      return "ãŸãã•ã‚“æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ãã¿ã«ã´ã£ãŸã‚Šã®æœ¬ã‚’æ¢ã—ã¦ãã‚‹ã­ã€œï¼âœ¨"
    } else if (questionCount < 5) {
      // 1ã€œ4å›ç›®ã¯è¤’ã‚ã¦æ¬¡ã®è³ªå•
      const responses = [
        "ã„ã„ã­ï¼ã¨ã£ã¦ã‚‚é¢ç™½ãã†ï¼",
        "ã™ã”ã„ã­ï¼ãã‚Œå¤§å¥½ãã ã‚ˆï¼",
        "ãªã‚‹ã»ã©ã€œï¼ã‚ˆãã‚ã‹ã£ãŸã‚ˆï¼",
        "ã‚ã‚ŠãŒã¨ã†ï¼ã¨ã£ã¦ã‚‚æ¥½ã—ãã†ã ã­ï¼"
      ]
      const randomResponse = responses[Math.floor(Math.random() * responses.length)]
      
      // è³ªå•ã®é †åº: åˆæœŸãƒ¡ãƒƒã‚»ãƒ¼ã‚¸(INTEREST_QUESTIONS[0]ç›¸å½“)â†’[1]â†’[2]â†’[3]â†’[4]â†’çµ‚äº†
      // questionCount ã¯ assistant ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ã®æ•°ãªã®ã§ã€2å›ç›®ã®è³ªå•ãªã‚‰ INTEREST_QUESTIONS[1] ã‚’ä½¿ã†
      const questionIndex = questionCount
      if (questionIndex >= 1 && questionIndex < INTEREST_QUESTIONS.length) {
        return `${randomResponse} ${INTEREST_QUESTIONS[questionIndex]}`
      } else {
        return `${randomResponse} ä»–ã«å¥½ããªã“ã¨ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ã­ï¼`
      }
    } else {
      // 6å›ç›®ä»¥é™ã¯çµ‚äº†ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ï¼ˆå¿µã®ãŸã‚ï¼‰
      return "ãŸãã•ã‚“æ•™ãˆã¦ãã‚Œã¦ã‚ã‚ŠãŒã¨ã†ï¼ãã¿ã«ã´ã£ãŸã‚Šã®æœ¬ã‚’æ¢ã—ã¦ãã‚‹ã­ã€œï¼âœ¨"
    }
  }
}

// æ›¸ç±ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã®å…¨ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼ˆé‡è¤‡å‰Šé™¤æ¸ˆã¿ï¼‰
const BOOK_KEYWORDS = [
  'æŒ‡ã§ãŸã©ã‚‹', 'é¸æŠ', 'è¿·è·¯', 'ã—ã‚Šã¨ã‚Š', 'ãƒ”ã‚¿ã‚´ãƒ©ã‚¹ã‚¤ãƒƒãƒ', 'ãƒ¦ãƒ¼ãƒ•ãƒ©ãƒ†ã‚¹', 'ã„ãã‚‰', 'å‚åŠ å‹çµµæœ¬', 'å‰µé€ æ€§', 'ã‚²ãƒ¼ãƒ æ„Ÿè¦š',
  'å‹æƒ…', 'æ€ã„ã‚„ã‚Š', 'è²¸ã—å€Ÿã‚Š', 'ç‹¬å æ¬²', 'æˆé•·', 'ãªã‹ã‚„ã¿ã‚', 'è±†', 'ãƒ™ãƒƒãƒ‰', 'åˆ†ã‹ã¡åˆã„', 'ç¤¾ä¼šæ€§',
  'ã‚¾ãƒ³ãƒ“', 'ãƒ›ãƒ©ãƒ¼ã‚³ãƒ¡ãƒ‡ã‚£', 'æ¢ã—çµµ', 'ã‚²ãƒ¼ãƒ ãƒ–ãƒƒã‚¯', 'ã‚³ãƒ­ã‚³ãƒ­ã‚³ãƒŸãƒƒã‚¯', 'ã‚®ãƒ£ã‚°', 'ãƒ¢ãƒ³ã‚¹ã‚¿ãƒ¼', 'èª­æ›¸ãŒè‹¦æ‰‹', 'ã‚¤ãƒ³ã‚¿ãƒ©ã‚¯ãƒ†ã‚£ãƒ–', 'ãªãŒã¨ã—ã‚„ã™ãªã‚Š',
  'å›³é‘‘', 'ã—ã‹ã‘çµµæœ¬', 'ã‚ãã‚‹', 'å¥½å¥‡å¿ƒ', 'å¹¼å…å‘ã‘', 'NEO', 'ç™ºè¦‹', 'è‹±èªã¤ã', 'å­¦ç¿’',
  'ç™¾ç§‘äº‹å…¸', 'ç§‘å­¦', 'ç–‘å•', 'å­¦ç¿’æŒ‡å°è¦é ˜', 'ç†ç§‘', 'ãƒ“ã‚¸ãƒ¥ã‚¢ãƒ«', 'å›³è§£', 'ç‰©ç†æ³•å‰‡', 'ç”Ÿå‘½ç§‘å­¦', 'å®‡å®™',
  'ç¬é–“', 'å†™çœŸ', 'ç‰©ç†', 'ãƒã‚¤ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚«ãƒ¡ãƒ©', 'é©šã', 'è¦–è¦šçš„å­¦ç¿’', 'èª²é¡Œå›³æ›¸', 'ä¼Šåœ°çŸ¥å›½å¤«',
  'å…±æ„Ÿ', 'å±ã‚‹', 'è¦ªå­é–¢ä¿‚', 'æ•™å¸«', 'ä¸ƒå¤•', 'å¿ƒæƒ…', 'ç†è§£', 'èª¤è§£', 'å­ã©ã‚‚ã®è¦–ç‚¹', 'ãã™ã®ãã—ã’ã®ã‚Š',
  'çŒ«', 'ãƒšãƒƒãƒˆ', 'å‘½', 'æ­»', 'å®¶æ—', 'çµ†', 'ãƒšãƒƒãƒˆãƒ­ã‚¹', 'åˆ¥ã‚Œ', 'æ„Ÿå‹•',
  'è¨€è‘‰éŠã³', 'èªå½™åŠ›', 'ã²ã‚‰ãŒãª', 'æ€è€ƒåŠ›', 'å›½èª', 'è¦ªå­', 'å‚åŠ å‹', 'åºƒç€¬å‹ç´€',
  'ãƒŸãƒƒã‚±', 'è¦³å¯ŸåŠ›', 'é›†ä¸­åŠ›', 'ã‚¸ã‚ªãƒ©ãƒ', 'è¦ªå­ã§æ¥½ã—ã‚€', 'ã‚¦ã‚©ãƒ«ã‚¿ãƒ¼ãƒ»ã‚¦ã‚£ãƒƒã‚¯', 'ç³¸äº•é‡é‡Œ', 'ã‚²ãƒ¼ãƒ ',
  'ãƒã‚±ãƒ¢ãƒ³', 'è¬è§£ã', 'ãªããªã', 'æ¾ä¸¸äº®å¾', 'ã²ã‚‰ã‚ã', 'ã‚¢ãƒ‹ãƒ¡', 'ãƒ‘ã‚ºãƒ«', 'ã‚­ãƒ£ãƒ©ã‚¯ã‚¿ãƒ¼',
  'ãƒ‰ãƒ©ãˆã‚‚ã‚“', 'æ¨ç†', 'ã‚¯ã‚¤ã‚º', 'è«–ç†çš„æ€è€ƒ', 'å­¦ç¿’ã¾ã‚“ãŒ', 'çŸ¥è­˜æ´»ç”¨åŠ›', 'æ¢åµ', 'è„³ãƒˆãƒ¬',
  'ãƒãƒ³ãƒ‘ã‚¤ã‚¢', 'åŠãƒãƒ³ãƒ‘ã‚¤ã‚¢', 'é‹å‘½', 'ãƒ€ãƒ¼ã‚¯ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼', 'å¥‡æ€ªãªã‚µãƒ¼ã‚«ã‚¹', 'ç”Ÿå­˜', 'é“å¾³çš„ã‚¸ãƒ¬ãƒ³ãƒ', 'æˆ¦ã„',
  'ãƒ‘ãƒ©ãƒ¬ãƒ«ãƒ¯ãƒ¼ãƒ«ãƒ‰', 'ç•°ä¸–ç•Œè»¢ç§»', 'ãƒ´ã‚§ãƒãƒ„ã‚£ã‚¢', 'æ­´å²ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼', 'é™°è¬€', 'é­”æ³•', 'ä»®é¢', 'ç—…æ°—ã¨ã®é—˜ã„', 'æ™‚ç©ºæ—…è¡Œ',
  'å†’é™ºãƒŸã‚¹ãƒ†ãƒªãƒ¼', 'æµ·è¾ºã®ç”º', 'ä¼èª¬ã®é­”ç‰©', 'å¿˜ã‚Œç‰©ä¿‚', 'å‡ºç”Ÿã®ç§˜å¯†', 'éœ§', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼', 'ãƒãƒ‡ã‚£ã‚‚ã®',
  'å°‚é–€å®¶ç›£ä¿®', 'DVDä»˜ã', 'è‡ªç”±ç ”ç©¶', 'æœ€æ–°æƒ…å ±', 'æœ¬æ ¼çš„',
  'æ–­é¢å›³', 'ä»•çµ„ã¿', 'æ§‹é€ ', 'æŠ€è¡“', 'ã‚‚ã®ã¥ãã‚Š', 'å†™çœŸçµµæœ¬', 'å†…éƒ¨',
  'ç’°å¢ƒå•é¡Œ', 'æµ·æ´‹æ±šæŸ“', 'ãƒ—ãƒ©ã‚¹ãƒãƒƒã‚¯ã”ã¿', 'SDGs', 'ç”Ÿæ…‹ç³»', 'ç¤¾ä¼šè²¢çŒ®', 'çµµæœ¬', 'ãƒªã‚µã‚¤ã‚¯ãƒ«', 'è¡Œå‹•', 'åœ°çƒ',
  'æ—¥æœ¬å²', 'é€šå²', 'å—é¨“', 'æ­´å²ã®æµã‚Œ', 'æ™‚ä»£è€ƒè¨¼', 'å±±å·å‡ºç‰ˆç¤¾', 'å²å®Ÿ', 'è¿‘ç¾ä»£å²', 'ç‰©èª',
  'ä¸–ç•Œå²', 'åæ¢åµã‚³ãƒŠãƒ³', 'æ­´å²ãƒŸã‚¹ãƒ†ãƒªãƒ¼', 'ã‚¿ã‚¤ãƒ ãƒˆãƒ©ãƒ™ãƒ«', 'ã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆ',
  'ä¸–ç•Œéºç”£', 'åœ°ç†', 'å›½éš›ç†è§£', 'æ–‡åŒ–éºç”£', 'è‡ªç„¶éºç”£', 'å¹³å’Œ', 'åœ°çƒã®å®ç‰©', 'æ—…è¡Œ',
  'å°å­¦æ ¡', 'æ—¥å¸¸', 'äººé–“é–¢ä¿‚', 'ãƒªã‚¢ãƒ«', 'å¤šæ§˜æ€§', 'å’æ¥­', 'ã‚¯ãƒ©ã‚¹', 'æ„Ÿæƒ…ã®æ©Ÿå¾®',
  'æŒ‘æˆ¦', 'åŠªåŠ›', 'è«¦ã‚ãªã„å¿ƒ', 'è…•ç›¸æ’²', 'è‡ªä¿¡', 'å…ˆç”Ÿ', 'ç¶™ç¶šã¯åŠ›ãªã‚Š', 'å¼±è™«',
  'ã„ã˜ã‚', 'å«‰å¦¬', 'ä¸­å­¦æ ¡', 'è¦–ç‚¹', 'è‘›è—¤', 'ç¤¾ä¼šå•é¡Œ', 'æ„Ÿæƒ…',
  'ã‚µãƒã‚¤ãƒãƒ«', 'è„±å‡ºã‚²ãƒ¼ãƒ ', 'è«–ç†ãƒ‘ã‚ºãƒ«',
  '5ã¤ã®åŠ›', 'ã‚²ãƒ¼ãƒŸãƒ•ã‚£ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'ãƒ‡ã‚¸ã‚¿ãƒ«æ•™æ', 'ãƒ—ãƒ­ã‚°ãƒ©ãƒŸãƒ³ã‚°çš„æ€è€ƒ',
  'å°‘å¥³æ¢åµ', 'ãƒšãƒ³ã‚®ãƒ³', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼ãƒŸã‚¹ãƒ†ãƒªãƒ¼', 'é¡ã®å›½', 'æ€ªç›—', 'è«–ç†', 'ã‚·ãƒªãƒ¼ã‚º',
  'ãƒ€ãƒ¼ã‚¦ã‚£ãƒ³', 'ã‚¬ãƒ©ãƒ‘ã‚´ã‚¹è«¸å³¶', 'é€²åŒ–è«–', 'ãƒ‰ãƒ©ã‚´ãƒ³', 'æ­´å²', 'çŸ¥çš„å¥½å¥‡å¿ƒ',
  'æ—¥é£Ÿ', 'å¤©æ–‡å­¦', 'ç¥è©±', 'å¤ªé™½', 'æœˆ', 'æ–‡åŒ–', 'è‡ªç„¶ç¾è±¡', 'æ¢ç©¶å¿ƒ',
  'é¦¬', 'æ—¥æœ¬ç¸¦æ–­', 'æ—…', 'å®Ÿè©±', 'å‹•ç‰©ã®è¦–ç‚¹', 'ç‰ˆç”»', 'è‡ªç„¶', 'äººé–“ç¤¾ä¼š',
  'ç§‘å­¦å²', 'ç™ºæ˜', 'å®Ÿé¨“', 'ç‰©ç†å­¦', 'ç§‘å­¦è€…', 'åŸç†',
  'äººä½“', 'è§£å‰–å­¦', 'ç”Ÿç‰©å­¦', 'å¥åº·', 'æ€æ˜¥æœŸ', 'ç—…æ°—', 'åŒ»å­¦', 'ç”Ÿå‘½',
  'æ–‡åŒ–å²', 'æ”¿æ²»å²', 'ç¤¾ä¼š', 'æ•™è‚²',
  'ä¼è¨˜', 'å¹³å¡šã‚‰ã„ã¦ã†', 'å¥³æ€§ã®æ¨©åˆ©', 'ç¤¾ä¼šé‹å‹•', 'æ­´å²äººç‰©', 'ã‚¸ã‚§ãƒ³ãƒ€ãƒ¼', 'ãƒ­ãƒ¼ãƒ«ãƒ¢ãƒ‡ãƒ«', 'é’éœ',
  'äººç‰©äº‹å…¸', 'å‚è€ƒæ›¸', 'æ¢ç©¶å­¦ç¿’', 'ç›¸é–¢é–¢ä¿‚', 'æ­´å²ç ”ç©¶', 'è³‡æ–™',
  'å–§å˜©', 'ä»²ç›´ã‚Š', 'å°å­¦ç”Ÿ', 'å¤ä¼‘ã¿', 'ã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³', 'é–¢è¥¿å¼',
  'ãƒŸã‚¹ãƒ†ãƒªãƒ¼', 'åŸ·äº‹', 'ãƒ¦ãƒ¼ãƒ¢ã‚¢', 'å®‰æ¥½æ¤…å­æ¢åµ', 'ä¼ç·š', 'ãƒˆãƒªãƒƒã‚¯',
  'ãƒãƒ™ãƒ©ã‚¤ã‚º', 'ã‚¢ã‚¯ã‚·ãƒ§ãƒ³', 'èª­æ›¸å…¥é–€', 'æ˜ ç”»', 'ã‚µã‚¹ãƒšãƒ³ã‚¹',
  'ç‰¹æ®Šèƒ½åŠ›', 'å¼•ãã“ã‚‚ã‚Š', 'ãƒãƒƒãƒˆç¤¾ä¼š', 'éƒ½å¸‚ä¼èª¬', 'ã‚¸ãƒ¥ãƒ‹ã‚¢æ–‡åº«',
  'æ¢æ¤œ', 'æƒ³åƒåŠ›', 'ç¸¦é–‹ãçµµæœ¬', 'æ•°ã®å­¦ç¿’', 'ç”Ÿãç‰©', 'æ‹›å¾…çŠ¶', 'å»ºç‰©', 'å‡ºä¼šã„',
  'ã‚­ãƒ£ãƒ³ãƒ‡ã‚£ãƒ¼', 'å¤‰èº«', 'ã„ãŸãšã‚‰', 'å‹•ç‰©', 'ãƒ”ãƒ³ãƒ', 'è§£æ±º', 'ã‚¿ãƒŒã‚­',
  'æç«œ', 'ãƒãƒˆãƒ«', 'éª¨', 'å‹‡æ°—', 'æ•µ',
  'ã‚«ãƒ¼ãƒ¬ãƒ¼ã‚¹', 'ã‚¾ãƒ­ãƒª', 'ä»²é–“', 'å›°é›£ã®å…‹æœ', 'ã‚­ãƒ„ãƒ',
  'ã‚¯ãƒ¬ãƒ¨ãƒ³', 'æ‰‹ç´™', 'å€‹æ€§', 'å›ºå®šè¦³å¿µ', 'å¯¾è©±', 'è‡ªå·±è¡¨ç¾', 'ä¸æº€',
  'æ“¬äººåŒ–', 'æ€ã„å‡º', 'æŒã¡ç‰©', 'å–ªå¤±æ„Ÿ', 'æ„Ÿè¬', 'å¿˜ã‚Œã‚‰ã‚ŒãŸã‚‚ã®', 'å½¹å‰²',
  'ä¹—ã‚Šç‰©', 'äº¤é€š', 'æŠ€è¡“å²', 'æ–‡æ˜', 'ç‰©æµ', 'é“å…·', 'äººé–“ã®å·¥å¤«',
  'æ°´ã®å¾ªç’°', 'ç§‘å­¦çµµæœ¬', 'è’¸ç™º', 'é›¨', 'é›ª', 'å·', 'æµ·',
  'é€²åŒ–', 'ç”Ÿç‰©', 'å‹•ç‰©', 'è±†çŸ¥è­˜', 'ç”Ÿæ…‹', 'å¼±ç‚¹',
  'çµ¶æ»…', 'ç”Ÿãç‰©', 'ç’°å¢ƒå•é¡Œ', 'ç†ç”±', 'ç”Ÿå­˜æˆ¦ç•¥',
  'æ˜†è™«', 'å¯¾æ±º', 'ãƒˆãƒ¼ãƒŠãƒ¡ãƒ³ãƒˆ', 'æœ€å¼·', 'ã‚·ãƒŸãƒ¥ãƒ¬ãƒ¼ã‚·ãƒ§ãƒ³', 'çŸ¥è­˜',
  'ã‚¢ãƒª', 'å…±ç”Ÿ', 'æ“¬æ…‹', 'è‡ªç„¶è¦³å¯Ÿ', 'ç”Ÿãæ®‹ã‚Šæˆ¦ç•¥',
  'ãƒ«ãƒ¼ãƒ«', 'éŠã³', 'ãƒœã‚¿ãƒ³', 'ç´„æŸ',
  'å•†åº—è¡—', 'ãŠåº—', 'è²·ã„ç‰©',
  'ãŠã°ã‘', 'å­¦æ ¡ã®æ€ªè«‡', 'æ€–ã„è©±', 'å¯¾å‡¦æ³•', 'å‹‡æ°—', 'å¦–æ€ª',
  'æ±Ÿæˆ¸æ™‚ä»£', 'å²¡ã£å¼•ã', 'æ•ç‰©å¸³', 'ä¹å°¾ã®ç‹',
  'UMA', 'æœªç¢ºèªå‹•ç‰©', 'è¬', 'ä¼èª¬', 'ã‚ªã‚«ãƒ«ãƒˆ', 'æ¢æ±‚', 'ç›®æ’ƒæƒ…å ±', 'è¶…å¸¸ç¾è±¡',
  'æ–™ç†', 'å”åŠ›', 'ã‹ã™ã¦ã‚‰', 'æ£®ã®å‹•ç‰©', 'ãƒ­ãƒ³ã‚°ã‚»ãƒ©ãƒ¼', 'ã­ãšã¿', 'é£Ÿè‚²',
  'ç€æ›¿ãˆ', 'è‡ªç«‹å¿ƒ', 'ç™ºæƒ³ã®è»¢æ›', 'å¹¼å…ã‚ã‚‹ã‚ã‚‹', 'å“²å­¦',
  'ç§˜å¯†åŸºåœ°', 'DIY', 'æ£®', 'ãƒ‘ãƒ¼ãƒ†ã‚£ãƒ¼',
  'æ°—æŒã¡', 'é“å¾³', 'è‰¯å¿ƒ', 'éŠ€è¡Œ', 'ã‚³ã‚¤ãƒ³', 'è‡ªå·±åçœ',
  'æœ¬', 'æ›¸åº—', 'èª­æ›¸', 'ã‚¢ã‚¤ãƒ‡ã‚¢', 'å°‚é–€åº—', 'æœ¬å¥½ã', 'å¤¢', 'ã‚°ãƒƒã‚º',
  'æ¯ã¨å¨˜', 'å¯‚ã—ã•', 'åƒãæ¯è¦ª', 'å’Œè“å­å±‹', 'æ°‘è©±', 'æ„›æƒ…',
  'èªçŸ¥ç—‡', 'ç¥–æ¯ã¨å­«', 'è€ã„', 'ä»‹è­·', 'è¨˜æ†¶',
  'çŠ¬', 'é£¼ã„ä¸»', 'ä¿¡é ¼', 'å­¤ç‹¬', 'ã‚³ãƒŸãƒ¥ãƒ‹ãƒ†ã‚£',
  'æ•°å­¦', 'å¥½ã', 'è¦–ç‚¹ã®è»¢æ›', 'ç§‘å­¦ã®ç›®', 'ãƒ‘ã‚¿ãƒ¼ãƒ³', 'å½¢', 'æ‰èƒ½',
  'é§„è“å­', 'å¹¸é‹', 'æ•™è¨“', 'çŸ­ç·¨é›†', 'æ‚©ã¿è§£æ±º', 'ä¸æ€è­°', 'å¥³ä¸»äºº',
  'å‹‡æ°—', 'çŸ¥æµ', 'å•é¡Œè§£æ±º', 'ç«œ', 'ã‚¯ãƒ©ã‚·ãƒƒã‚¯',
  'ãƒã‚¤ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ', 'ã‚‚ã®ã¥ãã‚Š', 'ç•°ä¸–ç•Œ', 'è¨˜æ†¶å–ªå¤±', 'ã‚¯ãƒ©ãƒ•ãƒˆ',
  'ã‚«ãƒ¢ãƒãƒã‚·', 'ã‚ªãƒ¼ã‚¹ãƒˆãƒ©ãƒªã‚¢', 'ãƒ‰ã‚¤ãƒ„', 'è¨ˆç”»',
  'å¸¸è­˜', 'é€†è»¢ã®ç™ºæƒ³', 'ä¾¡å€¤è¦³', 'åŠ´åƒ', 'å…„å¦¹',
  'ç•™å®ˆç•ª', 'è‡ªç”±', 'ä¸æ€è­°ãªå‡ºæ¥äº‹', 'å‹•ç‰©ã¨ã®å¯¾è©±', 'é€£ä½œ',
  'è»¢æ ¡ç”Ÿ', 'å­¤ç‹¬', 'ã‚«ãƒƒãƒ‘', 'è¡Œå‹•åŠ›', 'è‡ªå·±è‚¯å®š',
  'é›‘å­¦', 'æ®‹å¿µ',
  'å¤ä»£ç”Ÿç‰©',
  'æ·±æµ·', 'æµ·æ´‹ç”Ÿç‰©', 'æ½œæ°´è‰¦', 'å±æ©Ÿçš„çŠ¶æ³', 'ãƒãƒ¼ãƒ ãƒ¯ãƒ¼ã‚¯',
  'ç©ºæƒ³', 'ãƒãƒ³ã‚¬', 'æ¤œè¨¼', 'ãƒ’ãƒ¼ãƒ­ãƒ¼', 'èª­æœ¬',
  'é£Ÿæ–‡åŒ–', 'ä¿å­˜é£Ÿ', 'ä¸–ç•Œã®æ–™ç†', 'ä¹¾ç‡¥', 'é£Ÿã¹ç‰©', 'ç™ºé…µ',
  'åŒ—æ¥µ', 'å—æ¥µ', 'åœ°çƒæ¸©æš–åŒ–', 'æ¯”è¼ƒ', 'æ¢æ¤œ', 'è¨˜è€…', 'ãƒãƒ³ãƒ•ã‚£ã‚¯ã‚·ãƒ§ãƒ³',
  'ã‚«ãƒ©ã‚¹', 'å‹•ç‰©è¡Œå‹•å­¦', 'éƒ½å¸‚ã¨è‡ªç„¶', 'å…±å­˜', 'è¦³å¯Ÿæ—¥è¨˜', 'çŸ¥èƒ½',
  'äº‹ä»¶', 'èª­è€…ã¸ã®æŒ‘æˆ¦', 'è¨¼æ‹ ', 'çŠ¯äººå½“ã¦',
  'ã©ã‚“ã§ã‚“è¿”ã—', 'ã‚·ãƒ§ãƒ¼ãƒˆã‚·ãƒ§ãƒ¼ãƒˆ', 'æ„å¤–ãªçµæœ«', 'ãƒ›ãƒ©ãƒ¼', 'æœèª­',
  'æš—å·', 'æ¢åµå›£', 'å­¦æ ¡', 'ç§˜å¯†',
  'æ€ªç›—', 'ä¸­å­¦ç”Ÿ', 'æ­£ç¾©', '2ä»£ç›®', 'ç›¸æ£’',
  'FBI', 'æ˜ ç”»ãƒãƒ™ãƒ©ã‚¤ã‚º', 'èµ¤äº•ç§€ä¸€',
  'ãƒ•ãƒ¼ãƒ‰ãƒãƒ³ã‚¯', 'è²§å›°', 'åŠ©ã‘åˆã„', 'æ­£ç¾©æ„Ÿ', 'ã‚¤ã‚®ãƒªã‚¹',
  'ã‚Šã‚“ã”', 'ç–‘å•',
  'åº—ä¸»', 'ç©ºæƒ³',
  'å¤©å›½', 'ç”Ÿã¨æ­»', 'ãŠã˜ã„ã¡ã‚ƒã‚“', 'ãƒãƒ¼ãƒˆ',
  'é€€å±ˆ', 'å†…çœ',
  'ç•°ä¸–ä»£äº¤æµ', 'ä¼çµ±å·¥èŠ¸', 'ç«¹ç´°å·¥', 'è‡ªå·±çŠ ç‰²', 'å¿ƒã®æˆé•·', 'è·äºº', 'ç™’ã‚„ã—',
  'è²¬ä»»', 'ä¸ç™»æ ¡', 'ç£åŒ»å¸«',
  'å‘³å™Œ', 'å®¶æ¥­', 'å¸°å›½å­å¥³', 'ä¾¡å€¤ã®å†ç™ºè¦‹', 'æ—¥æœ¬æ–‡åŒ–', 'ç•°æ–‡åŒ–äº¤æµ',
  'æˆ¦å›½æ™‚ä»£', 'æ­¦å°†', 'å¤©ä¸‹çµ±ä¸€', 'è‹±é›„', 'ç¹”ç”°ä¿¡é•·',
  'å‰äºº', 'éšœå®³', 'å¸Œæœ›', 'ã‚µãƒªãƒãƒ³å…ˆç”Ÿ',
  'å¤å…¸', 'ç¥æ§˜', 'æ€ªç‰©', 'å›½ç”Ÿã¿', 'ä¼çµ±',
  'ã‚ªã‚ªã‚«ãƒŸ', 'å‹•ç‰©è¨˜', 'çŸ¥æµæ¯”ã¹', 'è‡ªç„¶ã¨ã®å…±å­˜', 'èª‡ã‚Š', 'å¤«å©¦æ„›', 'ã‚¢ãƒ¡ãƒªã‚«è¥¿éƒ¨', 'é‡ç”Ÿå‹•ç‰©',
  'ã‚±ã‚¤ãƒˆãƒ»ã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚º', 'æ¤ç‰©å­¦', 'ç’°å¢ƒä¿è­·', 'ã‚µãƒ³ãƒ‡ã‚£ã‚¨ã‚´', 'å¥³æ€§ç§‘å­¦è€…', 'æƒ…ç†±', 'ç·‘åŒ–', 'ãƒ‘ã‚¤ã‚ªãƒ‹ã‚¢',
  'å¤ç´™', 'ä»•äº‹', 'å²¡å±±',
  'ã‚¤ãƒ³ãƒ‰', 'æ”¹é©', 'ãƒªãƒ¼ãƒ€ãƒ¼ã‚·ãƒƒãƒ—', 'æ¤æ¨¹',
  'å±…å ´æ‰€', 'ã‚µãƒ¼ãƒ‰ãƒ—ãƒ¬ã‚¤ã‚¹', 'æ•‘æ¸ˆ', 'è¾»æ‘æ·±æœˆ',
  'ç„¡äººå³¶', 'æ¢æ¤œ',
  'é¬¼', 'ä¼æ‰¿', 'æ˜”è©±', 'ç•°ç•Œ', 'ç¥éš ã—',
  'é¡˜ã„', 'ä¸å¹¸', 'ç´…å­', 'æ¬²æœ›', 'ã‚ªãƒ ãƒ‹ãƒã‚¹',
  'å·¥å¤«', 'ç”Ÿå­˜', 'æŒ‘æˆ¦',
  'æ™‚é–“', 'å¥‘ç´„', 'å¯¿å‘½', 'å»£å¶‹ç²å­',
  'å–„ã¨æ‚ª', 'J.K.ãƒ­ãƒ¼ãƒªãƒ³ã‚°', 'å­¤å…',
  'ã‚¯ãƒ‹ãƒã‚¹', 'çµ¶æ»…ç¨®', 'å†ç™ºè¦‹', 'ç”°æ²¢æ¹–', 'è¥¿æ¹–', 'é­š'
]

// OpenAI APIã‚’ä½¿ã£ãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠï¼‰
async function extractKeywordsWithOpenAI(conversationHistory: Array<{role: string, content: string}>): Promise<KeywordExtractionResult> {
  try {
    const userMessages = conversationHistory
      .filter(msg => msg.role === 'user')
      .map(msg => msg.content)
      .join('\n')

    const systemPrompt = `ä»¥ä¸‹ã®ä¼šè©±ã‹ã‚‰ã€å­ã©ã‚‚ã®èˆˆå‘³ã‚„é–¢å¿ƒã‚’è¡¨ã™ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¦ãã ã•ã„ã€‚

åˆ©ç”¨å¯èƒ½ãªã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆï¼š
${BOOK_KEYWORDS.join(', ')}

ã“ã®ä¸­ã‹ã‚‰ã€ä¼šè©±å†…å®¹ã«æœ€ã‚‚é–¢é€£ã™ã‚‹30å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¦ãã ã•ã„ã€‚
é¸æŠã™ã‚‹éš›ã¯ä»¥ä¸‹ã®åŸºæº–ã§åˆ¤æ–­ã—ã¦ãã ã•ã„ï¼š
1. ç›´æ¥è¨€åŠã•ã‚Œã¦ã„ã‚‹ãƒˆãƒ”ãƒƒã‚¯
2. é–“æ¥çš„ã«é–¢é€£ã™ã‚‹å†…å®¹
3. å­ã©ã‚‚ãŒèˆˆå‘³ã‚’ç¤ºã—ãã†ãªé–¢é€£åˆ†é‡

ä»¥ä¸‹ã®JSONãƒ•ã‚©ãƒ¼ãƒãƒƒãƒˆã§å›ç­”ã—ã¦ãã ã•ã„ï¼š
{
  "keywords": ["ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰1", "ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰2", ...],
  "reasoning": "é¸æŠç†ç”±ã®èª¬æ˜"
}`

    const completion = await openai.chat.completions.create({
      model: 'gpt-4.1-2025-04-14',
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: `ä¼šè©±å†…å®¹:\n${userMessages}` }
      ],
      max_tokens: 300,
      temperature: 0.3
    })

    const responseText = completion.choices[0].message?.content || ''
    
    try {
      // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ãƒ†ã‚­ã‚¹ãƒˆã‚’æ¸…ç†ï¼ˆã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãƒãƒ¼ã‚«ãƒ¼ãªã©ã‚’å‰Šé™¤ï¼‰
      const cleanedText = responseText
        .replace(/```json\s*/g, '')
        .replace(/```\s*/g, '')
        .trim()
      
      // JSONã‹ã©ã†ã‹ãƒã‚§ãƒƒã‚¯ï¼ˆ{}ã§å§‹ã¾ã‚Š}ã§çµ‚ã‚ã‚‹ï¼‰
      if (!cleanedText.startsWith('{') || !cleanedText.endsWith('}')) {
        console.log('Response is not valid JSON format:', cleanedText)
        return await extractKeywordsFallback(conversationHistory)
      }
      
      const parsed = JSON.parse(cleanedText)
      
      // é¸æŠã•ã‚ŒãŸã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãŒå®Ÿéš›ã«ãƒªã‚¹ãƒˆã«å«ã¾ã‚Œã¦ã„ã‚‹ã‹ãƒã‚§ãƒƒã‚¯
      const validKeywords = Array.isArray(parsed.keywords) 
        ? parsed.keywords.filter((keyword: string) => BOOK_KEYWORDS.includes(keyword)).slice(0, 10)
        : []
      
      if (validKeywords.length === 0) {
        console.log('No valid keywords found, using fallback')
        return await extractKeywordsFallback(conversationHistory)
      }
      
      return {
        keywords: validKeywords,
        confidence: Math.min(validKeywords.length * 0.1 + 0.1, 0.9),
        reasoning: parsed.reasoning || `ãƒªã‚¹ãƒˆã‹ã‚‰${validKeywords.length}å€‹ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’é¸æŠã—ã¾ã—ãŸ`
      }
    } catch (parseError) {
      console.error('JSON parse error:', parseError)
      console.error('Original response text:', responseText)
      return await extractKeywordsFallback(conversationHistory)
    }
    
  } catch (error) {
    console.error('OpenAI keyword extraction error:', error)
    return await extractKeywordsFallback(conversationHistory)
  }
}

// ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºï¼ˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰é¸æŠï¼‰
async function extractKeywordsFallback(conversationHistory: Array<{role: string, content: string}>): Promise<KeywordExtractionResult> {
  const userMessages = conversationHistory
    .filter(msg => msg.role === 'user')
    .map(msg => msg.content)
    .join(' ')
  
  const extractedKeywords: string[] = []
  
  // æ›¸ç±ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ãƒªã‚¹ãƒˆã‹ã‚‰ä¼šè©±ã«é–¢é€£ã™ã‚‹ã‚‚ã®ã‚’æ¤œç´¢
  const userMessageLower = userMessages.toLowerCase()
  
  // ç›´æ¥ãƒãƒƒãƒãƒ³ã‚°ã™ã‚‹ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æ¤œç´¢
  for (const keyword of BOOK_KEYWORDS) {
    if (userMessageLower.includes(keyword.toLowerCase())) {
      extractedKeywords.push(keyword)
    }
  }
  
  // é–¢é€£èªã«ã‚ˆã‚‹ãƒãƒƒãƒãƒ³ã‚°ï¼ˆã‚ˆã‚Šå¹…åºƒãæ¤œç´¢ï¼‰
  const relatedPatterns = [
    { keywords: ['å‹æƒ…', 'ä»²é–“'], patterns: ['å‹é”', 'å‹äºº', 'ä»²è‰¯ã—', 'ä¸€ç·’'] },
    { keywords: ['å‹•ç‰©', 'ãƒšãƒƒãƒˆ', 'çŒ«', 'çŠ¬'], patterns: ['ã©ã†ã¶ã¤', 'ãƒšãƒƒãƒˆ', 'ã­ã“', 'ã„ã¬', 'çŠ¬', 'çŒ«'] },
    { keywords: ['å®‡å®™', 'ç§‘å­¦', 'å¤©æ–‡å­¦'], patterns: ['ã»ã—', 'æ˜Ÿ', 'å®‡å®™', 'æƒ‘æ˜Ÿ', 'å¤ªé™½', 'æœˆ'] },
    { keywords: ['å†’é™º', 'æ¢æ¤œ'], patterns: ['å†’é™º', 'æ¢æ¤œ', 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼', 'æ—…'] },
    { keywords: ['é­”æ³•', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼'], patterns: ['ã¾ã»ã†', 'é­”æ³•', 'ãƒ•ã‚¡ãƒ³ã‚¿ã‚¸ãƒ¼', 'é­”è¡“'] },
    { keywords: ['å­¦æ ¡', 'å°å­¦æ ¡'], patterns: ['ãŒã£ã“ã†', 'å­¦æ ¡', 'å‹‰å¼·', 'æˆæ¥­'] },
    { keywords: ['å®¶æ—', 'è¦ªå­'], patterns: ['å®¶æ—', 'ãŠæ¯ã•ã‚“', 'ãŠçˆ¶ã•ã‚“', 'å…„å¼Ÿ', 'å§‰å¦¹'] },
    { keywords: ['æ–™ç†', 'é£Ÿè‚²'], patterns: ['æ–™ç†', 'é£Ÿã¹ç‰©', 'ã‚¯ãƒƒã‚­ãƒ³ã‚°', 'ãŠè“å­'] },
    { keywords: ['éŸ³æ¥½'], patterns: ['éŸ³æ¥½', 'æ­Œ', 'æ¥½å™¨', 'ãƒ”ã‚¢ãƒ'] },
    { keywords: ['æç«œ'], patterns: ['æç«œ', 'åŒ–çŸ³', 'ãã‚‡ã†ã‚Šã‚…ã†'] },
    { keywords: ['èª­æ›¸', 'æœ¬'], patterns: ['æœ¬', 'èª­æ›¸', 'å°èª¬', 'ç‰©èª'] },
    { keywords: ['ã‚²ãƒ¼ãƒ ', 'ãƒã‚¤ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ'], patterns: ['ã‚²ãƒ¼ãƒ ', 'ãƒã‚¤ã‚¯ãƒ©', 'ãƒã‚¤ãƒ³ã‚¯ãƒ©ãƒ•ãƒˆ'] }
  ]
  
  for (const { keywords, patterns } of relatedPatterns) {
    if (patterns.some(pattern => userMessageLower.includes(pattern))) {
      for (const keyword of keywords) {
        if (BOOK_KEYWORDS.includes(keyword) && !extractedKeywords.includes(keyword)) {
          extractedKeywords.push(keyword)
        }
      }
    }
  }
  
  // ãƒ‡ãƒ•ã‚©ãƒ«ãƒˆã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ï¼ˆä½•ã‚‚è¦‹ã¤ã‹ã‚‰ãªã„å ´åˆï¼‰
  if (extractedKeywords.length === 0) {
    const defaultKeywords = ['å‹æƒ…', 'å†’é™º', 'å­¦æ ¡', 'å®¶æ—', 'æˆé•·']
    extractedKeywords.push(...defaultKeywords.filter(k => BOOK_KEYWORDS.includes(k)))
  }
  
  return {
    keywords: extractedKeywords.slice(0, 10),
    confidence: Math.min(extractedKeywords.length * 0.1, 0.8),
    reasoning: `ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒãƒ³ã‚°ã§ã€Œ${extractedKeywords.slice(0, 5).join('ã€')}ã€ãªã©ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã‚’æŠ½å‡ºã—ã¾ã—ãŸ`
  }
}

export async function POST(request: NextRequest) {
  try {
    const { userMessage, conversationHistory = [], mode = 'conversation' }: ChatRequest = await request.json()
    
    // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºãƒ¢ãƒ¼ãƒ‰ã§ã¯ userMessage ã¯ç©ºã§ã‚‚ OK
    if (mode !== 'extract_keywords' && !userMessage) {
      return NextResponse.json({
        success: false,
        message: 'ãƒ¦ãƒ¼ã‚¶ãƒ¼ãƒ¡ãƒƒã‚»ãƒ¼ã‚¸ãŒå¿…è¦ã§ã™'
      }, { status: 400 })
    }
    
    if (mode === 'extract_keywords') {
      // ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰æŠ½å‡ºãƒ¢ãƒ¼ãƒ‰
      const extractionResult = await extractKeywordsWithOpenAI(conversationHistory)
      
      return NextResponse.json({
        success: true,
        keywords: extractionResult.keywords,
        confidence: extractionResult.confidence,
        reasoning: extractionResult.reasoning,
        isComplete: true
      })
    } else {
      // ä¼šè©±ãƒ¢ãƒ¼ãƒ‰
      const response = await generateResponseWithOpenAI(userMessage, conversationHistory)
      
      // æ›´æ–°ã•ã‚ŒãŸä¼šè©±å±¥æ­´
      const updatedHistory = [
        ...conversationHistory,
        { role: 'user', content: userMessage },
        { role: 'assistant', content: response }
      ]
      
      // ä¼šè©±ãŒå®Œäº†ã—ãŸã‹ã©ã†ã‹ã‚’åˆ¤å®šï¼ˆ5å›ã®è³ªå•ã§å®Œäº†ï¼‰
      const assistantMessageCount = updatedHistory.filter(msg => msg.role === 'assistant').length
      const isComplete = assistantMessageCount >= 5
      
      return NextResponse.json({
        success: true,
        response,
        conversationHistory: updatedHistory,
        isComplete,
        nextQuestion: null // OpenAI ãŒå‹•çš„ã«ç”Ÿæˆã™ã‚‹ãŸã‚ null
      })
    }
    
  } catch (error) {
    console.error('Chat API error:', error)
    return NextResponse.json({
      success: false,
      message: 'ãƒãƒ£ãƒƒãƒˆæ©Ÿèƒ½ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      error: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 })
  }
}

// GET: ä¼šè©±ã‚’é–‹å§‹ã™ã‚‹
export async function GET() {
  try {
    const initialMessage = "ã“ã‚“ã«ã¡ã¯ï¼ãã¿ã«ã´ã£ãŸã‚Šã®æœ¬ã‚’è¦‹ã¤ã‘ã‚‹ãŠæ‰‹ä¼ã„ã‚’ã™ã‚‹ã‚ˆï¼ğŸ˜Š ã„ãã¤ã‹è³ªå•ã•ã›ã¦ã‚‚ã‚‰ã†ã­ã€‚å¥½ããªæœ¬ãŒã‚ã£ãŸã‚‰æ•™ãˆã¦ï¼ã©ã‚“ãªãŠè©±ãŒå¥½ãã‹ãªï¼Ÿ"
    
    return NextResponse.json({
      success: true,
      message: 'ãƒãƒ£ãƒƒãƒˆé–‹å§‹',
      response: initialMessage,
      conversationHistory: [
        { role: 'assistant', content: initialMessage }
      ],
      isComplete: false,
      nextQuestion: null
    })
    
  } catch (error) {
    console.error('Chat init error:', error)
    return NextResponse.json({
      success: false,
      message: 'ãƒãƒ£ãƒƒãƒˆåˆæœŸåŒ–ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿã—ã¾ã—ãŸ',
      error: error instanceof Error ? error.message : 'Unknown error'
    }, { status: 500 })
  }
} 